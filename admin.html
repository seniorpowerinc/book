<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ç®¡ç†ç¦®ç‰©é é¢</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 0;
      max-width: 600px;
      margin: auto;
      background: linear-gradient(to bottom right, #ffd89b 0%, #ffd89b 40%, #ff9a9e 100%);
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 0;
    }

    input,
    textarea,
    select {
      display: block;
      margin: 10px 0;
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }

    .step-button {
      width: 100%;
      padding: 12px 24px;
      margin: 11px;
      font-size: 20px;
      font-weight: bold;
      color: black;
      border: none;
      border-radius: 999px;
      background: linear-gradient(to right, #4facfe, #00f2fe);
      cursor: pointer;
      transition: background 0.3s;
    }

    .step-button:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }

    .disabled-label {
      background: #ccc !important;
      color: #666 !important;
      cursor: not-allowed !important;
      pointer-events: none;
    }

    .step-button:hover:not(:disabled) {
      background: linear-gradient(to right, #43e97b, #38f9d7);
    }

    .progress {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 20px 0 30px;
      gap: 6px;
      overflow-x: auto;
    }

    .step-indicator {
      flex: 0 0 auto;
      text-align: center;
      margin: 5px;
      position: relative;
    }

    .step-indicator::before {
      content: attr(data-step);
      display: inline-block;
      width: 30px;
      height: 30px;
      line-height: 30px;
      border-radius: 50%;
      background: #ccc;
      color: #fff;
      font-weight: bold;
      margin-bottom: 5px;
      transition: background 0.3s, transform 0.3s;
    }

    .step-indicator.done::before {
      content: "âœ“";
      background: #4facfe;
      transform: scale(1.2);
    }

    .step-indicator span {
      display: block;
      margin-top: 5px;
      font-size: 20px;
    }

    .arrow {
      font-size: 32px;
      color: #ccc;
      transition: color 0.3s;
    }

    .arrow.active {
      color: #00f2fe;
      animation: shake 0.5s infinite;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(2px);
      }

      50% {
        transform: translateX(-2px);
      }

      75% {
        transform: translateX(2px);
      }
    }

    /* éš±è—çœŸå¯¦æª”æ¡ˆ INPUT */
    #pdf,
    #pdfFile,
    #coverImage,
    #coverImageFile {
      display: none;
    }

    /* é¸æ“‡æª”æ¡ˆæŒ‰éˆ• */
    #fileLabel,
    #imageLabel {
      display: inline-block;
      padding: 12px 24px;
      margin: 15px;
      font-size: 22px;
      font-weight: bold;
      color: black;
      border: none;
      border-radius: 999px;
      background: linear-gradient(to right, #4facfe, #00f2fe);
      cursor: pointer;
      transition: background 0.3s;
    }

    #fileLabel:hover:not(.disabled-label),
    #imageLabel:hover:not(.disabled-label) {
      background: linear-gradient(to right, #43e97b, #38f9d7);
    }

    #selectedFileName,
    #selectedImageName {
      margin-top: 5px;
      font-size: 20px;
      color: #333;
    }

    /* éƒ¨ç½²é€²åº¦æ¢ */
    #deployProgressContainer {
      display: none;
      width: 100%;
      background: #eee;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 20px;
      font-size: 24px;
      color: #333;
      padding: 10px;
    }

    #deployProgressContainer a {
      font-weight: bold;
      color: #0077cc;
      text-decoration: underline;
      font-size: 26px;
    }

    #deployProgressBarInner {
      width: 0;
      height: 20px;
      background: linear-gradient(to right, #4facfe, #00f2fe);
      transition: width 0.3s;
    }

    .file-upload-section {
      margin: 20px 0;
      padding: 15px;
      border: 2px dashed #ccc;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
    }
  </style>
</head>

<body>
  <h1>ç®¡ç†ç¦®ç‰©é é¢</h1>

  <!-- é€²åº¦æ¢ -->
  <div class="progress" id="progressBar">
    <div class="step-indicator done" id="step0" data-step="0">
      <span>é–‹å§‹</span>
    </div>
    <div class="arrow active" id="arrow0">â¤</div>

    <div class="step-indicator" id="step1" data-step="1">
      <span>è¼‰å…¥è¨­å®š</span>
    </div>
    <div class="arrow" id="arrow1">â¤</div>

    <div class="step-indicator" id="step2" data-step="2">
      <span>é¸æ“‡æª”æ¡ˆ</span>
    </div>
    <div class="arrow" id="arrow2">â¤</div>

    <div class="step-indicator" id="step3" data-step="3">
      <span>ä¸Šå‚³æª”æ¡ˆ</span>
    </div>
    <div class="arrow" id="arrow3">â¤</div>

    <div class="step-indicator" id="step4" data-step="4">
      <span>æ›´æ–°ç¶²ç«™</span>
    </div>
  </div>

  <!-- æ¬„ä½ & æŒ‰éˆ• -->
  <label for="token">GitHub Token</label>
  <input type="password" id="token" placeholder="è¼¸å…¥ä½ çš„ GitHub Token" />
  <button id="loadButton" class="step-button" onclick="loadData()">
    1. è¼‰å…¥ç›®å‰è¨­å®š
  </button>

  <label for="pageTitle">ç¶²é é é¢åç¨±</label>
  <input id="pageTitle" />

  <label for="lang">é é¢èªè¨€</label>
  <select id="lang">
    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
    <option value="en">English</option>
    <option value="ja">æ—¥æœ¬èª</option>
  </select>

  <input id="pdf" readonly />
  <input id="coverImage" readonly />

  <!-- å°é¢åœ–ç‰‡ä¸Šå‚³å€å¡Š -->
  <div class="file-upload-section">
    <h3>ğŸ“¸ å°é¢åœ–ç‰‡</h3>
    <label id="imageLabel" for="coverImageFile">
      2A. é¸æ“‡å°é¢åœ–ç‰‡
    </label>
    <input type="file" id="coverImageFile" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
      onchange="onImageSelected()" />
    <div id="selectedImageName"></div>
  </div>

  <!-- PDF ä¸Šå‚³å€å¡Š -->
  <div class="file-upload-section">
    <h3>ğŸ“„ PDF æª”æ¡ˆ</h3>
    <label id="fileLabel" for="pdfFile">
      2B. é¸æ“‡ PDF æª”æ¡ˆ
    </label>
    <input type="file" id="pdfFile" accept="application/pdf" onchange="onPDFSelected()" />
    <div id="selectedFileName"></div>
  </div>

  <button id="uploadButton" class="step-button" onclick="uploadFiles()">
    3. ä¸Šå‚³æª”æ¡ˆ
  </button>

  <!-- éƒ¨ç½²é€²åº¦æ¢ -->
  <img id="imagePreview" style="display:none; max-width:100%; border-radius:12px; margin-top:10px" alt="åœ–ç‰‡é è¦½">
  <div id="deployProgressContainer" style="display:none">
    <div id="deployProgressBarInner" style="height: 20px; background: #4facfe; width: 0%;"></div>
  </div>

  <button id="updateButton" class="step-button" onclick="updateData()">
    4. æ›´æ–°ç¶²ç«™
  </button>

  <script>
    // å…¨åŸŸè®Šæ•¸
    let owner = '';
    let repo = '';
    let sha = '';
    let isDeploying = false;
    let currentStep = 0;
    let filesSelected = { pdf: false, image: false };

   function updateButtonStates() {
      document.getElementById('loadButton').disabled = currentStep !== 0;
      const fileLabel = document.getElementById('fileLabel');
      const imageLabel = document.getElementById('imageLabel');
      const uploadBtn = document.getElementById('uploadButton');
      const updateBtn = document.getElementById('updateButton');
      if (currentStep >= 1 && currentStep < 3) {
        fileLabel.classList.remove('disabled-label');
        imageLabel.classList.remove('disabled-label');
      } else {
        fileLabel.classList.add('disabled-label');
        imageLabel.classList.add('disabled-label');
      }
      uploadBtn.disabled = (currentStep !== 2 || !filesSelected.pdf || !filesSelected.image);
      updateBtn.disabled = (currentStep !== 3);
    }
    function markStepDone(stepNumber) {
      document.getElementById('step' + stepNumber).classList.add('done');
      for (let i = 0; i < 4; i++) {
        const arrow = document.getElementById('arrow' + i);
        if (i < stepNumber) {
          arrow.classList.add('active');
          arrow.style.animation = 'none';
        } else if (i === stepNumber) {
          arrow.classList.add('active');
          arrow.style.animation = 'shake 0.5s infinite';
        } else {
          arrow.classList.remove('active');
          arrow.style.animation = 'none';
        }
      }
    }

    // åœ¨ DOMContentLoaded åˆå§‹åŒ–é€²åº¦æ¢
    document.addEventListener('DOMContentLoaded', () => {
      markStepDone(0);
      updateButtonStates();
    });
    
    function onImageSelected() {
      const file = document.getElementById('coverImageFile').files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) {
        alert('åœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹é¸æ“‡ 2MB ä»¥ä¸‹åœ–ç‰‡');
        document.getElementById('coverImageFile').value = '';
        filesSelected.image = false;
        updateButtonStates();
        return;
      }
      document.getElementById('selectedImageName').textContent = 'å·²é¸æ“‡åœ–ç‰‡ï¼š' + file.name;
      const reader = new FileReader();
      reader.onload = e => {
        const preview = document.getElementById('imagePreview');
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
      filesSelected.image = true;
      if (currentStep < 2) {
        currentStep = 2;
        markStepDone(2);
      }
      updateButtonStates();
    }

    function onPDFSelected() {
      const file = document.getElementById('pdfFile').files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) {
        alert('PDF æª”æ¡ˆéå¤§ï¼Œè«‹é¸æ“‡ 10MB ä»¥ä¸‹');
        document.getElementById('pdfFile').value = '';
        filesSelected.pdf = false;
        updateButtonStates();
        return;
      }
      document.getElementById('selectedFileName').textContent = 'å·²é¸æ“‡æª”æ¡ˆï¼š' + file.name;
      filesSelected.pdf = true;
      if (currentStep < 2) {
        currentStep = 2;
        markStepDone(2);
      }
      updateButtonStates();
    }

    async function uploadFiles() {
      const token = getToken();
      const pdfFile = document.getElementById('pdfFile').files[0];
      const imageFile = document.getElementById('coverImageFile').files[0];
      if (!pdfFile || !imageFile) {
        alert('è«‹åŒæ™‚é¸æ“‡ PDF èˆ‡å°é¢åœ–ç‰‡');
        return;
      }
      alert('æª”æ¡ˆä¸Šå‚³ä¸­ï¼Œè«‹ç¨ç­‰');
      document.getElementById('uploadButton').disabled = true;
      document.getElementById('updateButton').disabled = true;
      try {
        await uploadFile(pdfFile, `pdfs/${pdfFile.name}`, token);
        document.getElementById('pdf').value = `pdfs/${pdfFile.name}`;
        await uploadFile(imageFile, `images/${imageFile.name}`, token);
        document.getElementById('coverImage').value = `images/${imageFile.name}`;
        await updateData(true);
        currentStep = 3;
        markStepDone(3);
        alert('æª”æ¡ˆèˆ‡è¨­å®šå·²æˆåŠŸæ›´æ–°');
      } catch (err) {
        alert('ä¸Šå‚³å¤±æ•—ï¼š' + err);
        currentStep = 2;
      } finally {
        updateButtonStates();
      }
    }

    async function updateData(fromUpload = false) {
      if (!fromUpload && isDeploying) {
        alert('éƒ¨ç½²ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        return;
      }
      if (!fromUpload) isDeploying = true;
      const token = getToken();
      const payload = {
        pageTitle: document.getElementById('pageTitle').value,
        lang: document.getElementById('lang').value,
        pdf: document.getElementById('pdf').value,
        coverImage: document.getElementById('coverImage').value,
        owner,
        repo
      };
      const getShaRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data.json`, {
        headers: { Authorization: `token ${token}` }
      });
      if (!getShaRes.ok) {
        alert('ç„¡æ³•å–å¾— data.json');
        return;
      }
      const getShaJson = await getShaRes.json();
      sha = getShaJson.sha;
      const putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data.json`, {
        method: 'PUT',
        headers: { Authorization: `token ${token}` },
        body: JSON.stringify({
          message: 'Update data.json',
          content: btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2)))),
          sha
        })
      });
      if (!putRes.ok) {
        alert('æ›´æ–° data.json å¤±æ•—');
        isDeploying = false;
        return;
      }
      if (!fromUpload) {
        setTimeout(() => {
          currentStep = 4;
          markStepDone(4);
          updateButtonStates();
          alert('è³‡æ–™æ›´æ–°æˆåŠŸï¼Œé–‹å§‹éƒ¨ç½²...');
          triggerWorkflow(token);
        }, 1000);
      }
    }

    async function triggerWorkflow(token) {
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/deploy.yml/dispatches`, {
          method: 'POST',
          headers: {
            Authorization: `token ${token}`,
            Accept: 'application/vnd.github+json'
          },
          body: JSON.stringify({ ref: 'main' })
        });
        if (!res.ok) throw new Error('éƒ¨ç½²è§¸ç™¼å¤±æ•—');
        alert('éƒ¨ç½²å·²æˆåŠŸè§¸ç™¼ï¼Œ5 ç§’å¾Œé¡¯ç¤ºé€²åº¦æ¢ä¸¦é–‹å§‹ç›£æ§é€²åº¦...');
        waitForWorkflow(token);
      } catch (err) {
        alert('éƒ¨ç½²éŒ¯èª¤ï¼š' + err.message);
        isDeploying = false;
      }
    }

    async function waitForWorkflow(token) {
      const container = document.getElementById('deployProgressContainer');
      const bar = document.getElementById('deployProgressBarInner');
      container.style.display = 'block';
      let progress = 0;
      const interval = setInterval(() => {
        progress = Math.min(progress + 5, 95);
        bar.style.width = `${progress}%`;
      }, 1000);
      let runId = null;
      while (!runId) {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs`, {
          headers: { Authorization: `token ${token}` }
        });
        const data = await res.json();
        const run = data.workflow_runs.find(r => r.name === 'deploy' && r.status !== 'queued');
        if (run) runId = run.id;
        await new Promise(r => setTimeout(r, 2000));
      }
      let completed = false;
      while (!completed) {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs/${runId}`, {
          headers: { Authorization: `token ${token}` }
        });
        const data = await res.json();
        if (data.status === 'completed') {
          completed = true;
          clearInterval(interval);
          bar.style.width = '100%';
          if (data.conclusion === 'success') {
            alert('ğŸ‰ éƒ¨ç½²æˆåŠŸï¼');
          } else {
            alert('âš ï¸ éƒ¨ç½²å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GitHub Actions');
          }
          isDeploying = false;
        }
        await new Promise(r => setTimeout(r, 3000));
      }
    }
  </script>
</body>
</html>
